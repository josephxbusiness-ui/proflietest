<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consumer Behavior Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #4b5563;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="container mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Consumer Behavior Dashboard</h1>

        <!-- Summary Cards Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <div class="card">
                <h3 class="text-lg font-semibold text-gray-600">จำนวนผู้ใช้งานทั้งหมด</h3>
                <p id="user-count" class="text-4xl font-bold text-blue-600 mt-2">กำลังโหลด...</p>
            </div>
            <div class="card">
                <h3 class="text-lg font-semibold text-gray-600">ความพึงพอใจเฉลี่ย</h3>
                <p id="satisfaction-score" class="text-4xl font-bold text-green-600 mt-2">กำลังโหลด...</p>
            </div>
            <div class="card">
                <h3 class="text-lg font-semibold text-gray-600">ยอดใช้จ่ายเฉลี่ย</h3>
                <p id="avg-spending" class="text-4xl font-bold text-purple-600 mt-2">กำลังโหลด...</p>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="card">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">จำนวนผู้ใช้งานต่อแพลตฟอร์ม</h3>
                <canvas id="platform-chart"></canvas>
            </div>
            <div class="card">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">คะแนนความพึงพอใจต่อแพลตฟอร์ม</h3>
                <canvas id="satisfaction-chart"></canvas>
            </div>
        </div>

        <!-- Data Table Section -->
        <div class="card">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">ข้อมูลทั้งหมด</h3>
            <div class="mb-4 flex flex-col md:flex-row gap-4">
                <input type="text" id="search-input" placeholder="ค้นหาตามชื่อแพลตฟอร์ม หรือหมวดสินค้า..." class="flex-1 p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                <select id="platform-filter" class="p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    <option value="">กรองตามแพลตฟอร์มทั้งหมด</option>
                </select>
                <select id="category-filter" class="p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    <option value="">กรองตามหมวดสินค้าทั้งหมด</option>
                </select>
            </div>
            <div class="table-container">
                <table id="data-table" class="min-w-full divide-y divide-gray-200 rounded-lg">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">อายุ</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">เพศ</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">แพลตฟอร์มที่ชอบ</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">คะแนนความพึงพอใจ</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">ยอดใช้จ่ายเฉลี่ย</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">หมวดสินค้า</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Google Sheet URL (Public)
            const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTOPNblJpFhytMMvTr3A9JqJ5eQK1O9XVbXheKmhPqeMLanWV7IpmQPgbihiwQQN257_WHzaDe7p2wc/pub?output=csv';

            let dashboardData = [];
            let platformChart, satisfactionChart;

            async function fetchData() {
                try {
                    const response = await fetch(sheetUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const text = await response.text();
                    dashboardData = parseCSV(text);
                    if (dashboardData.length > 0) {
                        renderDashboard(dashboardData);
                    } else {
                        document.getElementById('user-count').innerText = 'ไม่พบข้อมูล';
                        console.error('CSV data is empty or malformed.');
                    }
                } catch (error) {
                    console.error('Error fetching or parsing data:', error);
                    document.getElementById('user-count').innerText = 'เกิดข้อผิดพลาดในการโหลดข้อมูล';
                    document.getElementById('satisfaction-score').innerText = '--';
                    document.getElementById('avg-spending').innerText = '--';
                }
            }

            function parseCSV(text) {
                const lines = text.split('\n').filter(line => line.trim() !== '');
                if (lines.length < 2) return [];
                const headers = lines[0].split(',').map(header => header.trim());
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(value => value.trim());
                    if (values.length !== headers.length) continue;
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    data.push(row);
                }
                return data;
            }

            function renderDashboard(data) {
                if (platformChart) platformChart.destroy();
                if (satisfactionChart) satisfactionChart.destroy();

                const userCount = data.length;
                const totalSatisfaction = data.reduce((sum, item) => sum + (parseFloat(item.satisfaction_score) || 0), 0);
                const avgSatisfaction = userCount > 0 ? (totalSatisfaction / userCount).toFixed(2) : '0.00';
                const totalSpending = data.reduce((sum, item) => sum + (parseFloat(item.avg_spending) || 0), 0);
                const avgSpending = userCount > 0 ? (totalSpending / userCount).toFixed(2) : '0.00';

                document.getElementById('user-count').innerText = userCount.toLocaleString();
                document.getElementById('satisfaction-score').innerText = avgSatisfaction;
                document.getElementById('avg-spending').innerText = `${avgSpending} บาท`;

                const platforms = [...new Set(data.map(item => item.preferred_platform))].filter(Boolean).sort();
                const platformCounts = platforms.map(platform => data.filter(item => item.preferred_platform === platform).length);
                const satisfactionScores = platforms.map(platform => {
                    const platformUsers = data.filter(item => item.preferred_platform === platform);
                    const totalScore = platformUsers.reduce((sum, user) => sum + (parseFloat(user.satisfaction_score) || 0), 0);
                    return (platformUsers.length > 0 ? (totalScore / platformUsers.length) : 0).toFixed(2);
                });

                const ctx1 = document.getElementById('platform-chart').getContext('2d');
                platformChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: platforms,
                        datasets: [{
                            label: 'จำนวนผู้ใช้งาน',
                            data: platformCounts,
                            backgroundColor: 'rgb(59, 130, 246)',
                            borderRadius: 6,
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'จำนวน' } } } }
                });
                
                const ctx2 = document.getElementById('satisfaction-chart').getContext('2d');
                satisfactionChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: platforms,
                        datasets: [{
                            label: 'คะแนนความพึงพอใจ',
                            data: satisfactionScores,
                            backgroundColor: 'rgb(75, 192, 192)',
                            borderRadius: 6,
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'คะแนน' } } } }
                });

                populateTable(data);
                populateFilters(data);

                document.getElementById('search-input').addEventListener('keyup', filterTable);
                document.getElementById('platform-filter').addEventListener('change', filterTable);
                document.getElementById('category-filter').addEventListener('change', filterTable);
            }

            function populateTable(data) {
                const tableBody = document.getElementById('table-body');
                tableBody.innerHTML = '';
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-50 transition-colors";
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.age || '--'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.gender || '--'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.preferred_platform || '--'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.satisfaction_score || '--'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.avg_spending || '--'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.product_category || '--'}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            function populateFilters(data) {
                const platformFilter = document.getElementById('platform-filter');
                const categoryFilter = document.getElementById('category-filter');
                platformFilter.innerHTML = '<option value="">กรองตามแพลตฟอร์มทั้งหมด</option>';
                categoryFilter.innerHTML = '<option value="">กรองตามหมวดสินค้าทั้งหมด</option>';

                const platforms = [...new Set(data.map(item => item.preferred_platform))].filter(Boolean).sort();
                platforms.forEach(platform => {
                    const option = document.createElement('option');
                    option.value = platform;
                    option.textContent = platform;
                    platformFilter.appendChild(option);
                });

                const categories = [...new Set(data.map(item => item.product_category))].filter(Boolean).sort();
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });
            }

            function filterTable() {
                const searchValue = document.getElementById('search-input').value.toLowerCase();
                const platformValue = document.getElementById('platform-filter').value;
                const categoryValue = document.getElementById('category-filter').value;

                const filteredData = dashboardData.filter(item => {
                    const matchesSearch = searchValue === '' ||
                                        (item.preferred_platform && item.preferred_platform.toLowerCase().includes(searchValue)) ||
                                        (item.product_category && item.product_category.toLowerCase().includes(searchValue));
                    const matchesPlatform = platformValue === '' || item.preferred_platform === platformValue;
                    const matchesCategory = categoryValue === '' || item.product_category === categoryValue;

                    return matchesSearch && matchesPlatform && matchesCategory;
                });

                populateTable(filteredData);
            }

            fetchData();
        });
    </script>

</body>
</html>
